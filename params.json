{"name":"MSMQ counting comparisions","tagline":"Different methods of counting MSMQ messages and relative speed","body":"<h3>Introduction</h3>\r\nRecently I needed to create a means of visually monitoring the number of messages in multiple message queues.  This should of been relatively simple, create a UI to display the result from myMessageQueue.Count(), however the count method does not exist as part of the message queue class.\r\nThis post looks at the various different methods that you can use to count.\r\n<h3>Cursor Method</h3>\r\nWhen I searched for a solution most of the comments where using cursors.  This was the method that I initially used but when I had about &gt; 35,000 messages I found the count to be wildly erratic. The more messages you have in your queue the longer this method will take to count. For a full description of using cursors with MSMQ have a look on Microsoft h<a href=\"http://support.microsoft.com/kb/178516\">ttp://support.microsoft.com/kb/178516</a>.\r\n<pre>private MessageQueue _messageQueue;\r\nprivate int CountCursor()\r\n{\r\n    _messageQueue = new MessageQueue(\".\\\\private$\\\\pingpong\", QueueAccessMode.Peek);\r\n    int count = 0;\r\n    Cursor cursor = _messageQueue.CreateCursor();\r\n    Message m = CursorPeekWithoutTimeout(cursor, PeekAction.Current);\r\n    if (m != null)\r\n    {\r\n        count = 1;\r\n        while ((m = CursorPeekWithoutTimeout(cursor, PeekAction.Next)) != null)\r\n        {\r\n            count++;\r\n        }\r\n        if (m != null) m.Dispose();\r\n    }\r\n    cursor.Dispose();\r\n    return count;\r\n}\r\nprotected Message CursorPeekWithoutTimeout(Cursor cursor, PeekAction action)\r\n{\r\n    Message ret = null;\r\n    try\r\n    {\r\n        ret = _messageQueue.Peek(new TimeSpan(1), cursor, action);\r\n    }\r\n    catch (MessageQueueException mqe)\r\n    {\r\n        if (mqe.MessageQueueErrorCode != MessageQueueErrorCode.IOTimeout)\r\n        {\r\n            throw;\r\n        }\r\n    }\r\n    return ret;\r\n}\r\n\r\n</pre>\r\n<h3>GetAllMessages Method</h3>\r\n<code>GetAllMessages</code> returns a static copy of the messages in the queue, this is fine for small one off counts. In the real world you could have several hundred thousand large messages in the queue so to reduce the amount of information bought back we need to set up a message filter. The more messages you have in your queue the longer this method will take to count.\r\n<pre>var _messageQueue = new MessageQueue(\".\\\\private$\\pingpong\", QueueAccessMode.Peek);\r\nvar countFilter = new MessagePropertyFilter\r\n                        {\r\n                            AdministrationQueue = false,\r\n                            ArrivedTime = false,\r\n                            CorrelationId = false,\r\n                            Priority = false,\r\n                            ResponseQueue = false,\r\n                            SentTime = false,\r\n                            Body = false,\r\n                            Label = false,\r\n                            Id = false\r\n                        };\r\n_messageQueue.MessageReadPropertyFilter = countFilter;\r\nreturn _messageQueue.GetAllMessages().Length;</pre>\r\n<h3>GetEnumerator2 Method</h3>\r\n<code>GetEnumerator2</code> returns a dynamic list of messages in the queue.  The more messages you have in your queue the longer this method will take to count.\r\n<pre>var _messageQueue = new MessageQueue(\".\\\\private$\\pingpong\", QueueAccessMode.Peek);\r\nvar x = _messageQueue.GetMessageEnumerator2();\r\nint iCount = 0;\r\nwhile (x.MoveNext())\r\n{\r\n   iCount++;\r\n}\r\nreturn iCount;</pre>\r\n<h3>PowerShell (WMI) Method</h3>\r\nThis is by fastest method by far taking about 20ms regardless of how may messages there are to count. This is the only method for counting the message queues on other machines that you have access to.\r\n<pre>private int GetPowerShellCount()\r\n{\r\n    return GetPowerShellCount(\".\\\\private$\\pingpong\", Environment.MachineName, \"\", \"\");\r\n}\r\nprivate  int GetPowerShellCount(string queuePath, string machine,string username, string password)\r\n{\r\n    var path = string.Format(@\"\\\\{0}\\root\\CIMv2\", machine);\r\n    ManagementScope scope;\r\n    if (string.IsNullOrEmpty(username))\r\n    {\r\n            scope = new ManagementScope(path);\r\n    }\r\n    else\r\n    {\r\n        var options = new ConnectionOptions {Username = username, Password = password};\r\n        scope = new ManagementScope(path, options);\r\n    }\r\n    scope.Connect();\r\n    if (queuePath.StartsWith(\".\\\\\")) queuePath=queuePath.Replace(\".\\\\\",string.Format(\"{0}\\\\\",machine));\r\n    \r\n    string queryString = String.Format(\"SELECT * FROM Win32_PerfFormattedData_msmq_MSMQQueue\");\r\n    var query = new ObjectQuery(queryString);\r\n    var searcher = new ManagementObjectSearcher(scope, query);\r\n    IEnumerable&lt;int&gt; messageCountEnumerable =\r\n        from ManagementObject queue in searcher.Get()\r\n        select (int)(UInt64)queue.GetPropertyValue(\"MessagesInQueue\");\r\n    //IEnumerable&lt;string&gt; messageCountEnumerable =\r\n    //  from ManagementObject queue in searcher.Get()\r\n    //  select (string)queue.GetPropertyValue(\"Name\");\r\n    var x = messageCountEnumerable.First();\r\n    return x;\r\n}</pre>\r\n<h2>Testing</h2>\r\nI decided to create a test that would count the messages and count the timing for the messages to be counted. To run the tests included in source code you need to create a private MSMQ on your machine, the name of the queue does not matter as the application will use the first private queue it finds. The test application needs to run as an administrator as you will be purging the message queue before each tests start.\r\n\r\n<img class=\"alignnone  wp-image-18\" src=\"http://friedcode.files.wordpress.com/2014/06/msmqcounts.jpg?w=300\" alt=\"MSMQcounts\" width=\"605\" height=\"270\" />\r\n<h2>References</h2>\r\n<ul>\r\n\t<li>John Opincar: <a href=\"http://jopinblog.wordpress.com/2008/03/12/counting-messages-in-an-msmq-messagequeue-from-c/\">http://jopinblog.wordpress.com/2008/03/12/counting-messages-in-an-msmq-messagequeue-from-c/</a></li>\r\n\t<li>Emil Åström: <a href=\"http://www.meadow.se/wordpress/?p=648\">http://www.meadow.se/wordpress/?p=648</a></li>\r\n\t<li>Microsoft: <a href=\"http://msdn.microsoft.com/en-us/library/system.messaging.messagequeue.getallmessages.aspx\">http://msdn.microsoft.com/en-us/library/system.messaging.messagequeue.getallmessages.aspx</a></li>\r\n\t<li>Microsoft: <a href=\"http://msdn.microsoft.com/en-us/library/system.messaging.messagequeue.getmessageenumerator2.aspx\">http://msdn.microsoft.com/en-us/library/system.messaging.messagequeue.getmessageenumerator2.aspx</a></li>\r\n</ul>\r\n<h2>Post History</h2>\r\nThis article is a copy of a post I wrote on the Code Project website and can be found <a href=\"http://www.codeproject.com/Articles/346575/Message-Queue-Counting-Comparisions\">here</a> along with the source code.","google":"","note":"Don't delete this file! It's used internally to help with page regeneration."}